<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin - Pharmacy Review | Nrome</title>
	<link rel="icon" href="Images/nrome-logo.png" type="image/png" />
	<script src="config.js"></script>
	<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="css/styles.css">
	<style>
		.document-preview {
			max-width: 100%;
			max-height: 400px;
			object-fit: contain;
			border: 1px solid #ddd;
			border-radius: 4px;
		}
		.pharmacy-card {
			transition: all 0.3s ease;
		}
		.pharmacy-card:hover {
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		.status-badge {
			font-size: 0.85rem;
			padding: 0.4rem 0.8rem;
		}
		.document-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 1rem;
		}
		.doc-card {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 1rem;
			text-align: center;
			cursor: pointer;
			transition: all 0.2s;
		}
		.doc-card:hover {
			border-color: #007bff;
			background-color: #f8f9fa;
		}
	</style>
</head>
<body class="bg-light">
	<!-- Navigation -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
		<div class="container-fluid">
			<a class="navbar-brand" href="dashboard.html">
				<img src="Images/nrome-logo.png" alt="Nrome" height="30" class="d-inline-block align-text-top me-2">
				Nrome Admin
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav me-auto">
					<li class="nav-item">
						<a class="nav-link" href="dashboard.html">Dashboard</a>
					</li>
					<li class="nav-item">
						<a class="nav-link active" href="admin-pharmacy-review.html">Pharmacy Review</a>
					</li>
				</ul>
				<button class="btn btn-outline-light btn-sm" data-auth="signout">
					<i class="fas fa-sign-out-alt me-1"></i>Sign Out
				</button>
			</div>
		</div>
	</nav>

	<div class="container mt-4 mb-5">
		<!-- Header -->
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h2><i class="fas fa-hospital text-primary me-2"></i>Pharmacy Review Dashboard</h2>
				<p class="text-muted mb-0">Review and manage pharmacy applications</p>
			</div>
			<div>
				<button class="btn btn-outline-primary" onclick="loadPharmacies()">
					<i class="fas fa-sync-alt me-1"></i>Refresh
				</button>
			</div>
		</div>

		<!-- Stats Cards -->
		<div class="row g-3 mb-4">
			<div class="col-md-3">
				<div class="card border-warning">
					<div class="card-body">
						<h6 class="text-muted mb-2"><i class="fas fa-clock me-1"></i>Pending Review</h6>
						<h3 class="mb-0" id="pendingCount">-</h3>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card border-success">
					<div class="card-body">
						<h6 class="text-muted mb-2"><i class="fas fa-check-circle me-1"></i>Approved</h6>
						<h3 class="mb-0" id="approvedCount">-</h3>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card border-danger">
					<div class="card-body">
						<h6 class="text-muted mb-2"><i class="fas fa-times-circle me-1"></i>Rejected</h6>
						<h3 class="mb-0" id="rejectedCount">-</h3>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card border-primary">
					<div class="card-body">
						<h6 class="text-muted mb-2"><i class="fas fa-hospital me-1"></i>Active</h6>
						<h3 class="mb-0" id="activeCount">-</h3>
					</div>
				</div>
			</div>
		</div>

		<!-- Tabs for filtering -->
		<ul class="nav nav-tabs mb-3" id="pharmacyTabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
					<i class="fas fa-clock me-1"></i>Pending Review
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
					<i class="fas fa-check-circle me-1"></i>Approved
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button">
					<i class="fas fa-times-circle me-1"></i>Rejected
				</button>
			</li>
		</ul>

		<!-- Tab Content -->
		<div class="tab-content" id="pharmacyTabContent">
			<!-- Pending Tab -->
			<div class="tab-pane fade show active" id="pending" role="tabpanel">
				<div id="pendingList" class="row g-3"></div>
			</div>
			<!-- Approved Tab -->
			<div class="tab-pane fade" id="approved" role="tabpanel">
				<div id="approvedList" class="row g-3"></div>
			</div>
			<!-- Rejected Tab -->
			<div class="tab-pane fade" id="rejected" role="tabpanel">
				<div id="rejectedList" class="row g-3"></div>
			</div>
		</div>
	</div>

	<!-- Review Modal -->
	<div class="modal fade" id="reviewModal" tabindex="-1">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-hospital me-2"></i>Pharmacy Application Review
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="reviewContent"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Document Viewer Modal -->
	<div class="modal fade" id="documentModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="documentModalTitle">Document Viewer</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body text-center">
					<div id="documentViewer"></div>
				</div>
				<div class="modal-footer">
					<a href="#" id="downloadDocBtn" class="btn btn-primary" download>
						<i class="fas fa-download me-1"></i>Download
					</a>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/auth.js"></script>
	<script>
		let currentSession = null;
		let reviewModal, documentModal;

		async function initPage() {
			// Require authentication
			currentSession = await authHelpers.requireAuth();
			if (!currentSession) return;

			// Check if user is admin
			const { data: roleData, error: roleError } = await window.supabaseClient
				.from('user_role_assignments')
				.select('role')
				.eq('user_id', currentSession.user.id)
				.eq('role', 'admin')
				.single();

			if (roleError || !roleData) {
				alert('Access Denied: Admin privileges required');
				window.location.href = 'dashboard.html';
				return;
			}

			// Initialize modals
			reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
			documentModal = new bootstrap.Modal(document.getElementById('documentModal'));

			// Load pharmacies
			await loadPharmacies();

			// Set up sign out button
			document.querySelector('[data-auth="signout"]').addEventListener('click', async () => {
				await window.supabaseClient.auth.signOut();
				window.location.href = 'index.html';
			});
		}

		async function loadPharmacies() {
			try {
				// Fetch all pharmacies with their verification data
				const { data: pharmacies, error } = await window.supabaseClient
					.from('pharmacies')
					.select(`
						*,
						pharmacy_verifications (
							id,
							verification_status,
							sapc_certificate_url,
							business_license_url,
							tax_clearance_url,
							bank_confirmation_url,
							verified_at,
							verification_notes,
							verified_by
						)
					`)
					.order('created_at', { ascending: false });

				if (error) throw error;

				// Fetch owner profiles separately
				const ownerIds = [...new Set(pharmacies.map(p => p.owner_id).filter(Boolean))];
				let ownerProfiles = {};
				
				if (ownerIds.length > 0) {
					const { data: profiles } = await window.supabaseClient
						.from('user_profiles')
						.select('id, full_name, email')
						.in('id', ownerIds);
					
					if (profiles) {
						profiles.forEach(p => {
							ownerProfiles[p.id] = p;
						});
					}
				}

				// Attach owner profiles to pharmacies
				pharmacies.forEach(pharmacy => {
					pharmacy.owner_profile = ownerProfiles[pharmacy.owner_id] || null;
				});

				// Categorize pharmacies
				const pending = [];
				const approved = [];
				const rejected = [];
				let activeCount = 0;

				pharmacies.forEach(pharmacy => {
					const verification = pharmacy.pharmacy_verifications?.[0];
					const status = verification?.verification_status || 'pending';

					if (pharmacy.is_active) activeCount++;

					if (status === 'pending') {
						pending.push({ pharmacy, verification });
					} else if (status === 'approved') {
						approved.push({ pharmacy, verification });
					} else if (status === 'rejected') {
						rejected.push({ pharmacy, verification });
					}
				});

				// Update counts
				document.getElementById('pendingCount').textContent = pending.length;
				document.getElementById('approvedCount').textContent = approved.length;
				document.getElementById('rejectedCount').textContent = rejected.length;
				document.getElementById('activeCount').textContent = activeCount;

				// Render lists
				renderPharmacyList('pendingList', pending);
				renderPharmacyList('approvedList', approved);
				renderPharmacyList('rejectedList', rejected);

			} catch (error) {
				console.error('Error loading pharmacies:', error);
				alert('Failed to load pharmacies: ' + error.message);
			}
		}

		function renderPharmacyList(containerId, items) {
			const container = document.getElementById(containerId);
			
			if (items.length === 0) {
				container.innerHTML = '<div class="col-12"><div class="alert alert-info">No pharmacies in this category</div></div>';
				return;
			}

			container.innerHTML = items.map(({ pharmacy, verification }) => {
				const statusColor = {
					pending: 'warning',
					approved: 'success',
					rejected: 'danger'
				}[verification?.verification_status || 'pending'];

				return `
					<div class="col-md-6 col-lg-4">
						<div class="card pharmacy-card h-100">
							<div class="card-body">
								<div class="d-flex justify-content-between align-items-start mb-2">
									<h5 class="card-title mb-0">${pharmacy.pharmacy_name}</h5>
									<span class="badge bg-${statusColor} status-badge">
										${(verification?.verification_status || 'pending').toUpperCase()}
									</span>
								</div>
								<p class="text-muted small mb-2">
									<i class="fas fa-certificate me-1"></i>SAPC: ${pharmacy.sapc_number}
								</p>
								<p class="text-muted small mb-2">
									<i class="fas fa-map-marker-alt me-1"></i>${pharmacy.address}
								</p>
								<p class="text-muted small mb-2">
									<i class="fas fa-user me-1"></i>${pharmacy.owner_profile?.full_name || 'N/A'}
								</p>
								<p class="text-muted small mb-2">
									<i class="fas fa-envelope me-1"></i>${pharmacy.owner_profile?.email || 'N/A'}
								</p>
								<p class="text-muted small mb-3">
									<i class="fas fa-clock me-1"></i>Applied: ${new Date(pharmacy.created_at).toLocaleDateString()}
								</p>
								<button class="btn btn-primary btn-sm w-100" onclick="reviewPharmacy('${pharmacy.id}')">
									<i class="fas fa-eye me-1"></i>Review Application
								</button>
							</div>
						</div>
					</div>
				`;
			}).join('');
		}

		async function reviewPharmacy(pharmacyId) {
			try {
				// Fetch full pharmacy details
				const { data: pharmacy, error } = await window.supabaseClient
					.from('pharmacies')
					.select(`
						*,
						pharmacy_verifications (*)
					`)
					.eq('id', pharmacyId)
					.single();

				if (error) throw error;

				// Fetch owner profile separately
				let profile = null;
				if (pharmacy.owner_id) {
					const { data: profileData } = await window.supabaseClient
						.from('user_profiles')
						.select('*')
						.eq('id', pharmacy.owner_id)
						.single();
					profile = profileData;
				}

				const verification = pharmacy.pharmacy_verifications?.[0];

				// Build review content
				const content = `
					<div class="row">
						<div class="col-md-6">
							<h6 class="text-primary"><i class="fas fa-hospital me-2"></i>Pharmacy Information</h6>
							<table class="table table-sm">
								<tr><th>Pharmacy Name:</th><td>${pharmacy.pharmacy_name}</td></tr>
								<tr><th>SAPC Number:</th><td>${pharmacy.sapc_number}</td></tr>
								<tr><th>License Expiry:</th><td>${new Date(pharmacy.license_expiry).toLocaleDateString()}</td></tr>
								<tr><th>Phone:</th><td>${pharmacy.phone_number}</td></tr>
								<tr><th>Email:</th><td>${pharmacy.email}</td></tr>
								<tr><th>Address:</th><td>${pharmacy.address}</td></tr>
							</table>

							<h6 class="text-primary mt-3"><i class="fas fa-user me-2"></i>Owner Information</h6>
							<table class="table table-sm">
								<tr><th>Name:</th><td>${profile?.full_name || 'N/A'}</td></tr>
								<tr><th>Email:</th><td>${profile?.email || 'N/A'}</td></tr>
								<tr><th>Phone:</th><td>${profile?.phone_number || 'N/A'}</td></tr>
							</table>

							<h6 class="text-primary mt-3"><i class="fas fa-credit-card me-2"></i>Banking Details</h6>
							<table class="table table-sm">
								<tr><th>Account Name:</th><td>${pharmacy.bank_account_name || 'N/A'}</td></tr>
								<tr><th>Account Number:</th><td>${pharmacy.bank_account_number || 'N/A'}</td></tr>
								<tr><th>Bank Name:</th><td>${pharmacy.bank_name || 'N/A'}</td></tr>
								<tr><th>Branch Code:</th><td>${pharmacy.bank_branch_code || 'N/A'}</td></tr>
							</table>
						</div>

						<div class="col-md-6">
							<h6 class="text-primary"><i class="fas fa-file-alt me-2"></i>Submitted Documents</h6>
							<div class="document-grid">
								${verification?.sapc_certificate_url ? `
									<div class="doc-card" onclick="viewDocument('${verification.sapc_certificate_url}', 'SAPC Certificate')">
										<i class="fas fa-certificate fa-3x text-primary mb-2"></i>
										<p class="mb-0 small">SAPC Certificate</p>
									</div>
								` : '<div class="text-muted small">No SAPC cert</div>'}

								${verification?.business_license_url ? `
									<div class="doc-card" onclick="viewDocument('${verification.business_license_url}', 'Business License')">
										<i class="fas fa-file-contract fa-3x text-success mb-2"></i>
										<p class="mb-0 small">Business License</p>
									</div>
								` : '<div class="text-muted small">No license</div>'}

								${verification?.tax_clearance_url ? `
									<div class="doc-card" onclick="viewDocument('${verification.tax_clearance_url}', 'Tax Clearance')">
										<i class="fas fa-file-invoice-dollar fa-3x text-warning mb-2"></i>
										<p class="mb-0 small">Tax Clearance</p>
									</div>
								` : '<div class="text-muted small">No tax clearance</div>'}

								${verification?.bank_confirmation_url ? `
									<div class="doc-card" onclick="viewDocument('${verification.bank_confirmation_url}', 'Bank Confirmation')">
										<i class="fas fa-university fa-3x text-info mb-2"></i>
										<p class="mb-0 small">Bank Confirmation</p>
									</div>
								` : '<div class="text-muted small">No bank confirmation</div>'}
							</div>

							<div class="mt-4">
								<h6 class="text-primary"><i class="fas fa-clipboard-check me-2"></i>Review Actions</h6>
								
								<div class="mb-3">
									<label class="form-label">Admin Notes</label>
									<textarea class="form-control" id="adminNotes" rows="3" placeholder="Add review notes...">${verification?.verification_notes || ''}</textarea>
								</div>

								<div class="d-grid gap-2">
									${verification?.verification_status !== 'approved' ? `
										<button class="btn btn-success" onclick="approvePharmacy('${pharmacy.id}', '${verification?.id}')">
											<i class="fas fa-check-circle me-2"></i>Approve Pharmacy
										</button>
									` : `
										<button class="btn btn-warning" onclick="deactivatePharmacy('${pharmacy.id}')">
											<i class="fas fa-pause-circle me-2"></i>Deactivate Pharmacy
										</button>
									`}
									
									${verification?.verification_status !== 'rejected' ? `
										<button class="btn btn-danger" onclick="rejectPharmacy('${pharmacy.id}', '${verification?.id}')">
											<i class="fas fa-times-circle me-2"></i>Reject Application
										</button>
									` : ''}
								</div>
							</div>
						</div>
					</div>
				`;

				document.getElementById('reviewContent').innerHTML = content;
				reviewModal.show();

			} catch (error) {
				console.error('Error loading pharmacy details:', error);
				alert('Failed to load pharmacy details: ' + error.message);
			}
		}

		async function viewDocument(url, title) {
			try {
				// Get public URL from Supabase Storage
				const { data: { publicUrl } } = window.supabaseClient.storage
					.from('pharmacy-documents')
					.getPublicUrl(url.replace('pharmacy-documents/', ''));

				document.getElementById('documentModalTitle').textContent = title;
				document.getElementById('downloadDocBtn').href = publicUrl;
				
				// Display document (handle images and PDFs)
				const ext = url.split('.').pop().toLowerCase();
				let viewer = '';
				
				if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
					viewer = `<img src="${publicUrl}" class="document-preview" alt="${title}">`;
				} else if (ext === 'pdf') {
					viewer = `<iframe src="${publicUrl}" style="width: 100%; height: 500px; border: none;"></iframe>`;
				} else {
					viewer = `<div class="alert alert-info">
						<i class="fas fa-file me-2"></i>
						<a href="${publicUrl}" target="_blank">Click here to view/download ${title}</a>
					</div>`;
				}

				document.getElementById('documentViewer').innerHTML = viewer;
				documentModal.show();

			} catch (error) {
				console.error('Error viewing document:', error);
				alert('Failed to load document: ' + error.message);
			}
		}

		async function approvePharmacy(pharmacyId, verificationId) {
			const notes = document.getElementById('adminNotes').value;

			if (!confirm('Are you sure you want to APPROVE this pharmacy? This will allow them to receive orders.')) {
				return;
			}

			try {
				// Update verification status
				const { error: verifyError } = await window.supabaseClient
					.from('pharmacy_verifications')
					.update({
						verification_status: 'approved',
						verified_at: new Date().toISOString(),
						verified_by: currentSession.user.id,
						verification_notes: notes
					})
					.eq('id', verificationId);

				if (verifyError) throw verifyError;

				// Activate pharmacy
				const { error: activateError } = await window.supabaseClient
					.from('pharmacies')
					.update({
						is_verified: true,
						is_active: true
					})
					.eq('id', pharmacyId);

				if (activateError) throw activateError;

				alert('âœ… Pharmacy approved successfully! They can now receive orders.');
				reviewModal.hide();
				await loadPharmacies();

			} catch (error) {
				console.error('Error approving pharmacy:', error);
				alert('Failed to approve pharmacy: ' + error.message);
			}
		}

		async function rejectPharmacy(pharmacyId, verificationId) {
			const notes = document.getElementById('adminNotes').value;

			if (!notes.trim()) {
				alert('Please add notes explaining why this application is being rejected.');
				return;
			}

			if (!confirm('Are you sure you want to REJECT this pharmacy application?')) {
				return;
			}

			try {
				// Update verification status
				const { error: verifyError } = await window.supabaseClient
					.from('pharmacy_verifications')
					.update({
						verification_status: 'rejected',
						verified_at: new Date().toISOString(),
						verified_by: currentSession.user.id,
						verification_notes: notes
					})
					.eq('id', verificationId);

				if (verifyError) throw verifyError;

				// Ensure pharmacy is not active
				const { error: deactivateError } = await window.supabaseClient
					.from('pharmacies')
					.update({
						is_verified: false,
						is_active: false
					})
					.eq('id', pharmacyId);

				if (deactivateError) throw deactivateError;

				alert('Application rejected. Notes have been saved.');
				reviewModal.hide();
				await loadPharmacies();

			} catch (error) {
				console.error('Error rejecting pharmacy:', error);
				alert('Failed to reject pharmacy: ' + error.message);
			}
		}

		async function deactivatePharmacy(pharmacyId) {
			const notes = document.getElementById('adminNotes').value;

			if (!confirm('Are you sure you want to DEACTIVATE this pharmacy? They will no longer receive orders.')) {
				return;
			}

			try {
				const { error } = await window.supabaseClient
					.from('pharmacies')
					.update({ is_active: false })
					.eq('id', pharmacyId);

				if (error) throw error;

				alert('Pharmacy deactivated successfully.');
				reviewModal.hide();
				await loadPharmacies();

			} catch (error) {
				console.error('Error deactivating pharmacy:', error);
				alert('Failed to deactivate pharmacy: ' + error.message);
			}
		}

		// Initialize on page load
		document.addEventListener('DOMContentLoaded', initPage);
	</script>
</body>
</html>
