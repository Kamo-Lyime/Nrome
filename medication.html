<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nrome - Regulated Medication Logistics Platform</title>
    <link rel="icon" href="Images/nrome-logo.png" type="image/png" />
    <!-- Configuration -->
    <script src="config.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Paystack -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        :root {
            --nrome-trust: #0d6efd;
            --nrome-health: #198754;
            --nrome-calm: #6c757d;
            --nrome-teal: #20c997;
        }
        .nav-pills .nav-link {
            color: var(--nrome-calm);
        }
        .nav-pills .nav-link.active {
            background-color: var(--nrome-trust);
        }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-verified { background-color: #198754; }
        .badge-rejected { background-color: #dc3545; }
        .pharmacy-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .pharmacy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .pharmacy-card.selected {
            border: 2px solid var(--nrome-trust);
            background-color: #e7f1ff;
        }
        .locked-field {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .disclaimer-box {
            border-left: 4px solid #dc3545;
            background-color: #fff3cd;
            padding: 1rem;
        }
        .order-timeline {
            position: relative;
            padding-left: 2rem;
        }
        .order-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--nrome-calm);
        }
        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--nrome-calm);
        }
        .timeline-item.completed::before {
            background: var(--nrome-health);
            border-color: var(--nrome-health);
        }
        .med-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="position-center top-2 start-0 p-3 w-500">
        <img src="Images/nrome-logo.png" alt="Nrome Logo" class="logo" style="height: 130px;">
    </div>
    
    <!-- Main Navigation -->
    <div class="container mt-5 pt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">
                <i class="fas fa-capsules me-2" style="color: var(--nrome-health);"></i>
                Medication delivery
            </h1>
            <a href="dashboard.html" class="btn btn-outline-secondary">
                <i class="fas fa-home me-2"></i>Dashboard
            </a>
        </div>
        
        <!-- Regulatory Disclaimer -->
        <div class="disclaimer-box mb-4">
            <p class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Important:</strong> Nrome is a regulated logistics and orchestration platform. 
                We do <strong>NOT</strong> sell or dispense medication. All medication dispensing is performed 
                by licensed SAPC-registered pharmacies only. We facilitate safe delivery and prescription management.
            </p>
        </div>
        
        <!-- Primary Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="mainNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="order-tab" data-bs-toggle="pill" data-bs-target="#order-medication" type="button" role="tab">
                    <i class="fas fa-pills me-2"></i>Order Medication
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clinics-tab" data-bs-toggle="pill" data-bs-target="#clinics" type="button" role="tab">
                    <i class="fas fa-clinic-medical me-2"></i>Clinics
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hospitals-tab" data-bs-toggle="pill" data-bs-target="#hospitals" type="button" role="tab">
                    <i class="fas fa-hospital me-2"></i>Hospitals
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chronic-tab" data-bs-toggle="pill" data-bs-target="#chronic" type="button" role="tab">
                    <i class="fas fa-calendar-check me-2"></i>Chronic Medication
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-orders-tab" data-bs-toggle="pill" data-bs-target="#my-orders" type="button" role="tab">
                    <i class="fas fa-box me-2"></i>My Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="pill" data-bs-target="#profile" type="button" role="tab">
                    <i class="fas fa-user me-2"></i>Profile
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            
            <!-- ==================== ORDER MEDICATION TAB ==================== -->
            <div class="tab-pane fade show active" id="order-medication" role="tabpanel">
                
                <!-- Step 1: Enter Address -->
                <div class="card mb-3" id="step1-address">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>Step 1: Delivery Address
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="deliveryAddress" class="form-label">Street Address <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="deliveryAddress" placeholder="123 Main Street">
                            </div>
                            <div class="col-md-4">
                                <label for="suburb" class="form-label">Suburb</label>
                                <input type="text" class="form-control" id="suburb" placeholder="Sandton">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="city" placeholder="Johannesburg">
                            </div>
                            <div class="col-md-4">
                                <label for="province" class="form-label">Province <span class="text-danger">*</span></label>
                                <select class="form-select" id="province">
                                    <option value="">Select Province</option>
                                    <option value="Gauteng">Gauteng</option>
                                    <option value="Western Cape">Western Cape</option>
                                    <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                                    <option value="Eastern Cape">Eastern Cape</option>
                                    <option value="Free State">Free State</option>
                                    <option value="Limpopo">Limpopo</option>
                                    <option value="Mpumalanga">Mpumalanga</option>
                                    <option value="Northern Cape">Northern Cape</option>
                                    <option value="North West">North West</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode" placeholder="2196">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="deliveryInstructions" class="form-label">Special Delivery Instructions</label>
                            <textarea class="form-control" id="deliveryInstructions" rows="2" placeholder="E.g., Gate code, security instructions, preferred delivery time"></textarea>
                        </div>
                        <button class="btn btn-primary mt-3" onclick="proceedToPharmacySelection()">
                            <i class="fas fa-arrow-right me-2"></i>Find Nearby Pharmacies
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Select Pharmacy -->
                <div class="card mb-3 d-none" id="step2-pharmacy">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-hospital-user me-2"></i>Step 2: Select Licensed Pharmacy
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-shield-alt me-2"></i>
                            All pharmacies are licensed and registered with the South African Pharmacy Council (SAPC)
                        </div>
                        <div id="pharmacyList" class="row">
                            <!-- Pharmacies will be loaded here dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Order Type Selection -->
                <div class="card mb-3 d-none" id="step3-medication">
                    <div class="card-header" style="background-color: var(--nrome-teal); color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-pills me-2"></i>Step 3: How would you like to order?
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Order Type Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card pharmacy-card h-100" id="otcOrderOption" onclick="selectOrderType('otc')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shopping-basket fa-4x text-success mb-3"></i>
                                        <h5>Over-the-Counter (OTC)</h5>
                                        <p class="text-muted">Browse and select medications manually</p>
                                        <span class="badge bg-success">No prescription required</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card pharmacy-card h-100" id="prescriptionOrderOption" onclick="selectOrderType('prescription')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-prescription fa-4x text-primary mb-3"></i>
                                        <h5>Upload Prescription</h5>
                                        <p class="text-muted">Upload your prescription and let pharmacy fulfill it</p>
                                        <span class="badge bg-primary">Pharmacist will verify</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OTC Medication Selection (shown when OTC selected) -->
                        <div id="otcSelectionSection" class="d-none">
                            <h6 class="mb-3"><i class="fas fa-list me-2"></i>Select Medications</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success">
                                        <i class="fas fa-shopping-basket me-2"></i>Over-the-Counter (OTC)
                                    </h6>
                                    <small class="text-muted">Add directly to cart - no prescription required</small>
                                    <div id="otcMedications" class="mt-3">
                                        <!-- OTC medications loaded here -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning">
                                        <i class="fas fa-file-prescription me-2"></i>Prescription Required
                                    </h6>
                                    <div class="alert alert-warning">
                                        <small>
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Prescription medications require verification by a licensed pharmacist. Upload will be required in next step.
                                        </small>
                                    </div>
                                    <div id="rxMedications" class="mt-3">
                                        <!-- Prescription medications loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cart Summary -->
                            <div class="card mt-4 border-primary">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Your Order</h6>
                                </div>
                                <div class="card-body">
                                    <div id="cartItems">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-cart-plus fa-2x mb-2"></i><br>
                                            No items added yet
                                        </p>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span>Subtotal (Medication):</span>
                                        <span id="subtotal">R 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted">
                                        <span>Delivery Fee:</span>
                                        <span id="deliveryFee">R 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted">
                                        <span>Paystack Processing Fee:</span>
                                        <span id="paystackFee">R 0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <h5>Total Amount:</h5>
                                        <h5 class="text-success" id="totalAmount">R 0.00</h5>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-lg w-100 mt-3" onclick="proceedToUpload()" disabled id="proceedBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue
                            </button>
                        </div>

                        <!-- Prescription Upload Section (shown when prescription selected) -->
                        <div id="prescriptionUploadSection" class="d-none">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>How it works:</h6>
                                <ol class="mb-0">
                                    <li>Upload your prescription from a licensed practitioner</li>
                                    <li>Our pharmacist will verify and prepare your medication</li>
                                    <li>We'll deliver to your specified address</li>
                                </ol>
                            </div>

                            <div class="alert alert-danger">
                                <strong><i class="fas fa-shield-alt me-2"></i>POPIA Compliance:</strong> 
                                By uploading your prescription, you provide explicit consent for Nrome and the selected 
                                pharmacy to process your health information solely for medication delivery purposes.
                            </div>
                            
                            <div class="mb-3">
                                <label for="prescriptionFileStep3" class="form-label">
                                    Prescription Document <span class="text-danger">*</span>
                                </label>
                                <input type="file" class="form-control" id="prescriptionFileStep3" accept="image/*,.pdf" required>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Accepted formats: JPG, PNG, PDF (Max 5MB). Ensure prescription is clear and legible.
                                </small>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="popiaConsentStep3" required>
                                <label class="form-check-label" for="popiaConsentStep3">
                                    <strong>I consent</strong> to the processing of my prescription and health information 
                                    in accordance with POPIA (Protection of Personal Information Act, 2013)
                                </label>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-user-md me-2"></i>
                                <strong>Pharmacist Verification:</strong> A licensed SAPC-registered pharmacist will verify 
                                your prescription before dispensing. This is a mandatory regulatory requirement.
                            </div>
                            
                            <button class="btn btn-success btn-lg w-100" onclick="proceedWithPrescription()" id="uploadPrescriptionBtn">
                                <i class="fas fa-arrow-right me-2"></i>Proceed to Checkout & Payment
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Prescription Upload (if needed) -->
                <div class="card mb-3 d-none" id="step4-prescription">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>Step 4: Upload Prescription (POPIA Consent Required)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong><i class="fas fa-shield-alt me-2"></i>POPIA Compliance:</strong> 
                            By uploading your prescription, you provide explicit consent for Nrome and the selected 
                            pharmacy to process your health information solely for medication delivery orchestration purposes.
                        </div>
                        
                        <div class="mb-3">
                            <label for="prescriptionFile" class="form-label">
                                Prescription Document <span class="text-danger">*</span>
                            </label>
                            <input type="file" class="form-control" id="prescriptionFile" accept="image/*,.pdf">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Accepted formats: JPG, PNG, PDF (Max 5MB). Ensure prescription is clear and legible.
                            </small>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="popiaConsent" required>
                            <label class="form-check-label" for="popiaConsent">
                                <strong>I consent</strong> to the processing of my prescription and health information 
                                in accordance with POPIA (Protection of Personal Information Act, 2013)
                            </label>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-user-md me-2"></i>
                            <strong>Pharmacist Verification:</strong> A licensed SAPC-registered pharmacist will verify 
                            your prescription before dispensing. This is a mandatory regulatory requirement and cannot be bypassed.
                        </div>
                        
                        <button class="btn btn-success btn-lg w-100" onclick="proceedToCheckout()">
                            <i class="fas fa-arrow-right me-2"></i>Proceed to Checkout & Payment
                        </button>
                    </div>
                </div>
                
                <!-- Step 5: Checkout & Payment -->
                <div class="card mb-3 d-none" id="step5-checkout">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>Step 5: Payment & Confirmation
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-3">Order Summary</h6>
                        <div id="checkoutSummary" class="mb-3"></div>
                        
                        <hr>
                        
                        <h6>Payment Information</h6>
                        <div class="alert alert-info">
                            <i class="fab fa-paystack me-2"></i>
                            <strong>Secure Payment via Paystack</strong><br>
                            <small>Your payment will be automatically split between the pharmacy (for medication) 
                            and Nrome (for delivery service). All transactions are encrypted and POPIA-compliant.</small>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contactPhone" class="form-label">Contact Phone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="contactPhone" placeholder="+27 XX XXX XXXX" required>
                            </div>
                            <div class="col-md-6">
                                <label for="contactEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="contactEmail" placeholder="your@email.com" required>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="termsAccept" required>
                            <label class="form-check-label" for="termsAccept">
                                I accept the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms & Conditions</a>
                                and confirm all information is accurate
                            </label>
                        </div>
                        
                        <div class="alert alert-warning">
                            <small>
                                <strong>Note:</strong> Payment does not guarantee prescription approval. 
                                If the pharmacist rejects your prescription, you will receive a full refund within 5-7 business days.
                            </small>
                        </div>
                        
                        <button class="btn btn-success btn-lg w-100" onclick="initiatePayment()">
                            <i class="fas fa-lock me-2"></i>Pay Securely with Paystack
                        </button>
                    </div>
                </div>
                
            </div>
            
            <!-- ==================== CLINICS TAB ==================== -->
            <div class="tab-pane fade" id="clinics" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clinic-medical me-2"></i>Clinic Prescriptions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            View prescriptions issued by clinics. <strong>Clinics do NOT dispense medication</strong> - 
                            they only issue prescriptions which must be fulfilled by licensed pharmacies.
                        </div>
                        
                        <h6 class="mb-3">My Clinics</h6>
                        <div id="myClinics">
                            <!-- Clinics loaded here -->
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3">Active Clinic Prescriptions</h6>
                        <div id="clinicPrescriptions">
                            <!-- Clinic prescriptions loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== HOSPITALS TAB ==================== -->
            <div class="tab-pane fade" id="hospitals" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-hospital me-2"></i>Hospital Discharge & Long-term Care
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-lock me-2"></i>
                            <strong>Locked UX:</strong> Hospital discharge prescriptions cannot be edited or modified. 
                            No medication browsing or substitutions allowed.
                        </div>
                        
                        <h6 class="mb-3">Discharge Orders</h6>
                        <div id="dischargeOrders">
                            <!-- Hospital discharge orders loaded here -->
                        </div>
                        
                        <hr>
                        
                        <h6 class="mb-3">Caregiver Assignments</h6>
                        <div id="caregiverAssignments">
                            <!-- Caregiver info loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== CHRONIC MEDICATION TAB ==================== -->
            <div class="tab-pane fade" id="chronic" role="tabpanel">
                <div class="card">
                    <div class="card-header" style="background-color: var(--nrome-health); color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-check me-2"></i>Chronic Medication Program
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Chronic medication enrollments are initiated by your pharmacy, clinic, or hospital. 
                            Orders are automatically generated monthly based on your delivery schedule.
                        </div>
                        
                        <h6 class="mb-3">
                            <i class="fas fa-pills me-2"></i>Active Chronic Medications
                        </h6>
                        <div id="chronicMedications">
                            <!-- Chronic enrollments loaded here -->
                        </div>
                        
                        <div class="alert alert-warning mt-4">
                            <strong>Pause/Resume Rules:</strong>
                            <ul class="mb-0">
                                <li>You can pause deliveries for up to 3 months</li>
                                <li>Cancellation requires pharmacist approval</li>
                                <li>Prescription must remain valid</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== MY ORDERS TAB ==================== -->
            <div class="tab-pane fade" id="my-orders" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-box me-2"></i>My Orders & Tracking
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-sm btn-outline-secondary me-2 filter-btn active" data-filter="all">All Orders</button>
                            <button class="btn btn-sm btn-outline-warning filter-btn" data-filter="pending">Pending Verification</button>
                            <button class="btn btn-sm btn-outline-info filter-btn" data-filter="in-progress">In Progress</button>
                            <button class="btn btn-sm btn-outline-success filter-btn" data-filter="delivered">Delivered</button>
                        </div>
                        
                        <div id="ordersList">
                            <!-- Orders loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PROFILE TAB ==================== -->
            <div class="tab-pane fade" id="profile" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>My Profile
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="profileFullName">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="profilePhone">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="profileEmail" readonly class="locked-field">
                                <small class="text-muted">Email cannot be changed directly. Contact support.</small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ID Number (SA)</label>
                                    <input type="text" class="form-control" id="profileIdNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="profileDOB">
                                </div>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Default Delivery Address</h6>
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <input type="text" class="form-control" id="profileAddress">
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" id="profileCity">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Province</label>
                                    <select class="form-select" id="profileProvince">
                                        <option value="Gauteng">Gauteng</option>
                                        <option value="Western Cape">Western Cape</option>
                                        <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                                        <option value="Eastern Cape">Eastern Cape</option>
                                        <option value="Free State">Free State</option>
                                        <option value="Limpopo">Limpopo</option>
                                        <option value="Mpumalanga">Mpumalanga</option>
                                        <option value="Northern Cape">Northern Cape</option>
                                        <option value="North West">North West</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="profilePostalCode">
                                </div>
                            </div>
                            
                            <hr>
                            
                            <h6 class="mb-3">POPIA Consent Management</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="consentProcessing" checked disabled>
                                <label class="form-check-label" for="consentProcessing">
                                    Data processing for medication delivery (Required)
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="consentMarketing">
                                <label class="form-check-label" for="consentMarketing">
                                    Marketing communications (Optional)
                                </label>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="updateProfile()">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Order Tracking Modal -->
    <div class="modal fade" id="orderTrackingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-route me-2"></i>Order Tracking
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="trackingContent">
                        <!-- Order timeline loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Terms & Conditions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Platform Role</h6>
                    <p>Nrome is a regulated logistics and orchestration platform. We do NOT sell, prescribe, or dispense medication. 
                    All dispensing is performed exclusively by licensed SAPC-registered pharmacies.</p>
                    
                    <h6>2. Prescription Verification</h6>
                    <p>All prescription medications require mandatory verification by a licensed pharmacist before dispensing. 
                    This process cannot be bypassed. Invalid or expired prescriptions will be rejected.</p>
                    
                    <h6>3. State Machine - No Skipping Steps</h6>
                    <p>Orders follow a strict state machine: Created → Rx Uploaded → Rx Verified → Prepared → Driver Assigned 
                    → Picked Up → Delivered → Closed. Steps cannot be skipped or rolled back.</p>
                    
                    <h6>4. Payment & Refunds</h6>
                    <p>Payments are processed via Paystack and split between the pharmacy and delivery service. 
                    If a prescription is rejected, full refunds are issued within 5-7 business days.</p>
                    
                    <h6>5. POPIA Compliance</h6>
                    <p>By using this platform, you consent to processing of your personal and health information in accordance 
                    with the Protection of Personal Information Act (POPIA, 2013). All data is encrypted and access is logged.</p>
                    
                    <h6>6. User Roles & Boundaries</h6>
                    <p>Patients can order and track. Caregivers can track and receive. Drivers deliver but cannot see medication details. 
                    Only pharmacists can verify and dispense. These boundaries are strictly enforced.</p>
                    
                    <h6>7. Liability Disclaimer</h6>
                    <p>Nrome is not liable for: (a) medication interactions or adverse reactions, (b) dispensing errors by pharmacies, 
                    (c) delays beyond our control, or (d) incomplete or inaccurate patient information.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // Supabase client is already initialized in auth.js as window.supabaseClient
        // We'll use window.supabaseClient throughout this script
        
        let currentOrder = {
            patient_id: null,
            delivery_address: '',
            pharmacy_id: null,
            prescription_id: null,
            items: [],
            requires_prescription: false,
            subtotal: 0,
            delivery_fee: 35.00, // Default ZAR delivery fee
            total: 0
        };
        
        // Require authentication
        document.addEventListener('DOMContentLoaded', async () => {
            authHelpers.requireAuth();
            const user = await getCurrentUser();
            if (user) {
                // Ensure user profile exists before proceeding
                const profileReady = await ensureUserProfile();
                if (!profileReady) {
                    alert('Unable to initialize user profile. Please refresh the page or contact support.');
                    return;
                }
                
                currentOrder.patient_id = user.id;
                loadUserData();
                loadPharmacies();
                loadMedications();
                loadOrders();
                loadChronicMedications();
            }
        });
        
        async function getCurrentUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            return user;
        }
        
        async function ensureUserProfile() {
            const user = await getCurrentUser();
            if (!user) return false;
            
            // Check if user profile exists
            const { data: profile, error: fetchError } = await supabaseClient
                .from('user_profiles')
                .select('*')
                .eq('id', user.id)
                .single();
            
            // If profile doesn't exist, create it
            if (fetchError && fetchError.code === 'PGRST116') {
                console.log('User profile not found, creating one...');
                
                // Get user metadata from auth
                const fullName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
                const email = user.email || '';
                const phone = user.user_metadata?.phone || user.phone || '';
                
                const { data: newProfile, error: createError } = await supabaseClient
                    .from('user_profiles')
                    .insert({
                        id: user.id,
                        full_name: fullName,
                        email: email,
                        phone_number: phone || 'Not provided',
                        consent_given: true,
                        consent_date: new Date().toISOString(),
                        profile_complete: false
                    })
                    .select()
                    .single();
                
                if (createError) {
                    console.error('Error creating user profile:', createError);
                    alert('Unable to create user profile. Please contact support. Error: ' + createError.message);
                    return false;
                }
                
                console.log('User profile created successfully:', newProfile);
                return true;
            }
            
            if (fetchError) {
                console.error('Error fetching user profile:', fetchError);
                return false;
            }
            
            return true;
        }
        
        async function loadUserData() {
            const user = await getCurrentUser();
            if (!user) return;
            
            const { data: profile } = await supabaseClient
                .from('user_profiles')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (profile) {
                document.getElementById('profileFullName').value = profile.full_name || '';
                document.getElementById('profilePhone').value = profile.phone_number || '';
                document.getElementById('profileEmail').value = profile.email || '';
                document.getElementById('profileIdNumber').value = profile.id_number || '';
                document.getElementById('profileDOB').value = profile.date_of_birth || '';
                document.getElementById('profileAddress').value = profile.street_address || '';
                document.getElementById('profileCity').value = profile.city || '';
                document.getElementById('profileProvince').value = profile.province || '';
                document.getElementById('profilePostalCode').value = profile.postal_code || '';
                document.getElementById('consentMarketing').checked = profile.marketing_consent || false;
            }
        }
        
        async function loadPharmacies() {
            const { data: pharmacies } = await supabaseClient
                .from('pharmacies')
                .select('*')
                .eq('is_active', true)
                .eq('is_verified', true);
            
            const container = document.getElementById('pharmacyList');
            if (!pharmacies || pharmacies.length === 0) {
                container.innerHTML = '<p class="text-muted">No pharmacies available in your area</p>';
                return;
            }
            
            container.innerHTML = pharmacies.map(pharmacy => `
                <div class="col-md-6 mb-3">
                    <div class="card pharmacy-card" onclick="selectPharmacy('${pharmacy.id}')">
                        <div class="card-body">
                            <h6 class="card-title">${pharmacy.name}</h6>
                            <p class="mb-1"><small><i class="fas fa-certificate me-2 text-success"></i>SAPC: ${pharmacy.sapc_number}</small></p>
                            <p class="mb-1"><small><i class="fas fa-map-marker-alt me-2"></i>${pharmacy.city}, ${pharmacy.province}</small></p>
                            <p class="mb-0"><small><i class="fas fa-phone me-2"></i>${pharmacy.phone}</small></p>
                            ${pharmacy.operating_hours ? `<p class="mb-0 mt-2"><small class="text-muted">Operating hours available</small></p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadMedications() {
            const { data: meds } = await supabaseClient
                .from('medications')
                .select('*')
                .eq('is_active', true);
            
            const otcContainer = document.getElementById('otcMedications');
            const rxContainer = document.getElementById('rxMedications');
            
            const otcMeds = meds?.filter(m => m.medication_type === 'otc') || [];
            const rxMeds = meds?.filter(m => m.requires_prescription) || [];
            
            otcContainer.innerHTML = otcMeds.map(med => `
                <div class="med-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${med.name}</strong><br>
                            <small class="text-muted">${med.dosage_form || ''} ${med.strength || ''}</small><br>
                            <span class="text-success fw-bold">R ${med.indicative_price?.toFixed(2) || '0.00'}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-success" onclick="addToCart('${med.id}', '${med.name}', ${med.indicative_price}, false)">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-muted">No OTC medications available</p>';
            
            rxContainer.innerHTML = rxMeds.map(med => `
                <div class="med-item border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${med.name}</strong><br>
                            <small class="text-muted">${med.dosage_form || ''} ${med.strength || ''}</small><br>
                            <span class="text-warning"><i class="fas fa-prescription me-1"></i>Prescription Required</span>
                        </div>
                        <button class="btn btn-sm btn-outline-warning" onclick="addToCart('${med.id}', '${med.name}', ${med.indicative_price}, true)">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-muted">No prescription medications available</p>';
        }
        
        function proceedToPharmacySelection() {
            const address = document.getElementById('deliveryAddress').value;
            const city = document.getElementById('city').value;
            const province = document.getElementById('province').value;
            
            if (!address || !city || !province) {
                alert('Please enter your complete delivery address');
                return;
            }
            
            currentOrder.delivery_address = `${address}, ${city}, ${province}`;
            
            document.getElementById('step1-address').classList.add('d-none');
            document.getElementById('step2-pharmacy').classList.remove('d-none');
        }
        
        function selectPharmacy(pharmacyId) {
            currentOrder.pharmacy_id = pharmacyId;
            
            document.querySelectorAll('.pharmacy-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            setTimeout(() => {
                document.getElementById('step2-pharmacy').classList.add('d-none');
                document.getElementById('step3-medication').classList.remove('d-none');
            }, 500);
        }

        // Order type selection
        let orderType = null; // 'otc' or 'prescription'
        
        function selectOrderType(type) {
            orderType = type;
            
            // Visual feedback on cards
            document.getElementById('otcOrderOption').classList.remove('selected');
            document.getElementById('prescriptionOrderOption').classList.remove('selected');
            
            if (type === 'otc') {
                document.getElementById('otcOrderOption').classList.add('selected');
                document.getElementById('otcSelectionSection').classList.remove('d-none');
                document.getElementById('prescriptionUploadSection').classList.add('d-none');
                loadMedications(); // Load medication catalog for OTC
            } else if (type === 'prescription') {
                document.getElementById('prescriptionOrderOption').classList.add('selected');
                document.getElementById('prescriptionUploadSection').classList.remove('d-none');
                document.getElementById('otcSelectionSection').classList.add('d-none');
            }
        }

        // New function to proceed with prescription upload
        async function proceedWithPrescription() {
            const fileInput = document.getElementById('prescriptionFileStep3');
            const consentCheckbox = document.getElementById('popiaConsentStep3');
            
            if (!fileInput.files[0]) {
                alert('Please upload your prescription');
                return;
            }
            
            if (!consentCheckbox.checked) {
                alert('Please provide consent to process your health information');
                return;
            }
            
            // Store prescription file for later upload
            currentOrder.prescriptionFile = fileInput.files[0];
            currentOrder.requires_prescription = true;
            currentOrder.prescription_only = true; // Flag for prescription-only orders
            
            // Skip to checkout since we don't have manual medication selection
            document.getElementById('step3-medication').classList.add('d-none');
            document.getElementById('step5-checkout').classList.remove('d-none');
        }
        
        function addToCart(medId, medName, price, requiresRx) {
            const existing = currentOrder.items.find(item => item.medication_id === medId);
            if (existing) {
                existing.quantity++;
            } else {
                currentOrder.items.push({
                    medication_id: medId,
                    medication_name: medName,
                    unit_price: price,
                    quantity: 1,
                    requires_prescription: requiresRx
                });
            }
            
            if (requiresRx) {
                currentOrder.requires_prescription = true;
            }
            
            updateCart();
        }
        
        function updateCart() {
            const cartContainer = document.getElementById('cartItems');
            
            if (currentOrder.items.length === 0) {
                cartContainer.innerHTML = '<p class="text-muted text-center"><i class="fas fa-cart-plus fa-2x mb-2"></i><br>No items added yet</p>';
                document.getElementById('proceedBtn').disabled = true;
                return;
            }
            
            cartContainer.innerHTML = currentOrder.items.map((item, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>${item.medication_name}</strong>
                        ${item.requires_prescription ? '<span class="badge badge-pending ms-2">Rx</span>' : ''}
                        <br>
                        <small>R ${item.unit_price.toFixed(2)} x ${item.quantity}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Calculate fees
            currentOrder.subtotal = currentOrder.items.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
            
            // Paystack fee: 1.5% + R2.00 (customer pays this)
            const paystackPercentage = 0.015;
            const paystackFixed = 2.00;
            currentOrder.paystack_fee = ((currentOrder.subtotal + currentOrder.delivery_fee) * paystackPercentage) + paystackFixed;
            
            // Nrome platform fee: 10% of medication subtotal (deducted from pharmacy portion)
            currentOrder.platform_fee = currentOrder.subtotal * 0.10;
            currentOrder.pharmacy_amount = currentOrder.subtotal - currentOrder.platform_fee;
            
            // Total customer pays (medication + delivery + Paystack fee)
            currentOrder.total = currentOrder.subtotal + currentOrder.delivery_fee + currentOrder.paystack_fee;
            
            document.getElementById('subtotal').textContent = `R ${currentOrder.subtotal.toFixed(2)}`;
            document.getElementById('deliveryFee').textContent = `R ${currentOrder.delivery_fee.toFixed(2)}`;
            document.getElementById('paystackFee').textContent = `R ${currentOrder.paystack_fee.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `R ${currentOrder.total.toFixed(2)}`;
            
            document.getElementById('proceedBtn').disabled = false;
        }
        
        function removeFromCart(index) {
            currentOrder.items.splice(index, 1);
            if (currentOrder.items.length === 0 || !currentOrder.items.some(item => item.requires_prescription)) {
                currentOrder.requires_prescription = false;
            }
            updateCart();
        }
        
        function proceedToUpload() {
            if (currentOrder.requires_prescription) {
                document.getElementById('step3-medication').classList.add('d-none');
                document.getElementById('step4-prescription').classList.remove('d-none');
            } else {
                proceedToCheckout();
            }
        }
        
        async function proceedToCheckout() {
            const user = await getCurrentUser();
            if (!user) {
                alert('Please log in to continue');
                return;
            }

            if (currentOrder.requires_prescription) {
                const file = document.getElementById('prescriptionFile').files[0];
                const consent = document.getElementById('popiaConsent').checked;
                
                if (!file || !consent) {
                    alert('Please upload prescription and provide POPIA consent');
                    return;
                }

                try {
                    // Upload prescription to Supabase Storage
                    const fileName = `${user.id}/${Date.now()}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                        .from('prescriptions')
                        .upload(fileName, file);

                    if (uploadError) {
                        alert('Error uploading prescription: ' + uploadError.message);
                        return;
                    }

                    // Get public URL
                    const { data: urlData } = window.supabaseClient.storage
                        .from('prescriptions')
                        .getPublicUrl(fileName);

                    // Create prescription record in database
                    const prescriptionNumber = `RX-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`.toUpperCase();
                    
                    const { data: prescription, error: prescriptionError } = await window.supabaseClient
                        .from('prescriptions')
                        .insert({
                            prescription_number: prescriptionNumber,
                            patient_id: user.id,
                            uploaded_by: user.id,
                            upload_source: 'patient_upload',
                            issue_date: new Date().toISOString().split('T')[0],
                            valid_from: new Date().toISOString().split('T')[0],
                            valid_until: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0], // 90 days default
                            prescription_document_url: urlData.publicUrl,
                            prescription_document_type: file.type,
                            status: 'pending_verification',
                            can_be_used_for_orders: true
                        })
                        .select()
                        .single();

                    if (prescriptionError) {
                        alert('Error saving prescription: ' + prescriptionError.message);
                        return;
                    }

                    // Store prescription ID for order creation
                    currentOrder.prescription_id = prescription.id;
                    
                    alert('✅ Prescription uploaded successfully! A pharmacist will verify it.');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Error uploading prescription: ' + error.message);
                    return;
                }
            }
            
            document.getElementById('step4-prescription')?.classList.add('d-none');
            document.getElementById('step3-medication')?.classList.add('d-none');
            document.getElementById('step5-checkout').classList.remove('d-none');
            
            document.getElementById('checkoutSummary').innerHTML = `
                <div class="alert alert-secondary">
                    <strong>Delivery to:</strong> ${currentOrder.delivery_address}<br>
                    <strong>Total Items:</strong> ${currentOrder.items.length}<br>
                    <strong>Amount to Pay:</strong> R ${currentOrder.total.toFixed(2)}
                </div>
            `;
        }
        
        async function initiatePayment() {
            const phone = document.getElementById('contactPhone').value;
            const email = document.getElementById('contactEmail').value;
            const termsAccepted = document.getElementById('termsAccept').checked;
            
            if (!phone || !email || !termsAccepted) {
                alert('Please fill all required fields and accept terms');
                return;
            }
            
            // Ensure cart calculations are up to date
            updateCart();
            
            // Create order in database first
            const orderNumber = 'NRM-' + Date.now();
            
            const { data: order, error } = await window.supabaseClient
                .from('orders')
                .insert({
                    order_number: orderNumber,
                    patient_id: currentOrder.patient_id,
                    ordered_by: currentOrder.patient_id,
                    pharmacy_id: currentOrder.pharmacy_id,
                    prescription_id: currentOrder.prescription_id || null,
                    is_prescription_order: currentOrder.requires_prescription,
                    is_otc_order: !currentOrder.requires_prescription,
                    delivery_address: currentOrder.delivery_address,
                    delivery_contact_phone: phone,
                    delivery_contact_name: document.getElementById('profileFullName').value,
                    subtotal: currentOrder.subtotal,
                    delivery_fee: currentOrder.delivery_fee,
                    paystack_fee: currentOrder.paystack_fee,
                    platform_fee: currentOrder.platform_fee,
                    pharmacy_amount: currentOrder.pharmacy_amount,
                    total_amount: currentOrder.total,
                    payment_status: 'pending',
                    status: currentOrder.prescription_id ? 'rx_uploaded' : 'created'
                })
                .select()
                .single();
            
            if (error) {
                alert('Error creating order: ' + error.message);
                return;
            }
            
            console.log('Order created successfully:', order);
            
            // Store order ID globally for payment callback
            window.currentOrderId = order.id;
            window.currentOrderNumber = orderNumber;
            
            // Insert order items
            for (const item of currentOrder.items) {
                await supabaseClient
                    .from('order_items')
                    .insert({
                        order_id: order.id,
                        medication_id: item.medication_id,
                        medication_name: item.medication_name,
                        medication_type: item.requires_prescription ? 'prescription' : 'otc',
                        quantity: item.quantity,
                        unit_price: item.unit_price,
                        total_price: item.unit_price * item.quantity
                    });
            }
            
            console.log('Order items inserted. Order ID:', order.id);
            
            // Initialize Paystack payment
            console.log('Paystack Key:', window.CONFIG.PAYSTACK_PUBLIC_KEY);
            console.log('Amount (ZAR):', currentOrder.total);
            console.log('Amount (cents):', Math.round(currentOrder.total * 100));
            console.log('Email:', email);
            console.log('Reference:', orderNumber);
            
            const paystackConfig = {
                key: window.CONFIG.PAYSTACK_PUBLIC_KEY,
                email: email,
                amount: Math.round(currentOrder.total * 100), // Convert to cents and round to integer
                currency: 'ZAR',
                ref: orderNumber,
                callback: function(response) {
                    console.log('=== PAYSTACK CALLBACK STARTED ===');
                    console.log('Payment Response:', response);
                    console.log('Order ID to update:', window.currentOrderId);
                    console.log('Order Number:', window.currentOrderNumber);
                    
                    if (!window.currentOrderId) {
                        alert('ERROR: Order ID not found! Payment reference: ' + response.reference);
                        return;
                    }
                    
                    // Update order payment status
                    console.log('Attempting to update order...');
                    console.log('Order ID:', window.currentOrderId);
                    console.log('Payment Reference:', response.reference);
                    
                    // Update payment_reference and status
                    window.supabaseClient
                        .from('orders')
                        .update({
                            payment_reference: response.reference,
                            payment_status: 'paid',
                            status: 'pending_confirmation'
                        })
                        .eq('id', window.currentOrderId)
                        .then(({ data, error }) => {
                            console.log('=== UPDATE RESPONSE ===');
                            console.log('Error:', error);
                            console.log('Data:', data);
                            
                            if (error) {
                                console.error('❌ Full error:', error);
                                alert('⚠️ Payment successful but order update failed!\n\n' +
                                      'Payment Reference: ' + response.reference + '\n' +
                                      'Order ID: ' + window.currentOrderId + '\n\n' +
                                      'Error: ' + error.message + '\n\n' +
                                      'URGENT: Run FIX_ALL_ENUMS.sql in Supabase SQL Editor!\n' +
                                      'This will fix the database columns.');
                                      
                                // Redirect anyway so user can see their order
                                setTimeout(() => {
                                    window.location.href = 'medication.html';
                                }, 3000);
                            } else {
                                console.log('✅ Order updated successfully!');
                                alert('✅ Payment Successful!\n\n' +
                                      'Reference: ' + response.reference + '\n' +
                                      'Order Number: ' + window.currentOrderNumber + '\n\n' +
                                      'Your order is now awaiting pharmacy confirmation.');
                                
                                setTimeout(() => {
                                    window.location.href = 'medication.html';
                                }, 1500);
                            }
                        })
                        .catch((err) => {
                            console.error('❌ Catch error:', err);
                            alert('⚠️ Payment successful!\n\n' +
                                  'Reference: ' + response.reference + '\n\n' +
                                  'Note: Database update failed, but your payment was processed.\n' +
                                  'Run FIX_ALL_ENUMS.sql to fix the issue.');
                            setTimeout(() => {
                                window.location.href = 'medication.html';
                            }, 3000);
                        });
                },
                onClose: function() {
                    console.log('Paystack modal closed');
                    alert('Payment window closed. Your order has been saved but payment is pending.');
                }
            };
            
            console.log('Paystack Config:', paystackConfig);
            
            const handler = PaystackPop.setup(paystackConfig);
            
            handler.openIframe();
        }
        
        async function loadOrders() {
            const user = await getCurrentUser();
            if (!user) return;
            
            const { data: orders } = await supabaseClient
                .from('orders')
                .select(`
                    *,
                    pharmacies(name),
                    order_items(*)
                `)
                .eq('patient_id', user.id)
                .order('created_at', { ascending: false });
            
            const container = document.getElementById('ordersList');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p class="text-muted">No orders yet</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const itemCount = order.order_items?.length || 0;
                const statusInfo = getOrderStatusInfo(order.status);
                const paymentBadge = order.payment_reference 
                    ? '<span class="badge bg-success ms-2"><i class="fas fa-check-circle"></i> PAID</span>' 
                    : '<span class="badge bg-warning ms-2"><i class="fas fa-exclamation-circle"></i> UNPAID</span>';
                
                return `
                <div class="card mb-3 border-${statusInfo.color}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-2">${order.order_number} ${paymentBadge}</h6>
                                <p class="mb-1"><small><i class="fas fa-hospital me-1"></i><strong>Pharmacy:</strong> ${order.pharmacies?.name || 'N/A'}</small></p>
                                <p class="mb-1"><small><i class="fas fa-pills me-1"></i><strong>Items:</strong> ${itemCount} medication(s)</small></p>
                                <p class="mb-1"><small><i class="fas fa-calendar me-1"></i><strong>Ordered:</strong> ${new Date(order.created_at).toLocaleString()}</small></p>
                                <p class="mb-2"><small><i class="fas fa-map-marker-alt me-1"></i><strong>Delivery:</strong> ${order.delivery_address}</small></p>
                                
                                <!-- Order Progress Tracker -->
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-${statusInfo.color}" role="progressbar" style="width: ${statusInfo.progress}%" aria-valuenow="${statusInfo.progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span class="badge bg-${statusInfo.color}">${statusInfo.icon} ${statusInfo.text}</span>
                            </div>
                            <div class="col-md-4 text-end">
                                <h5 class="text-success mb-2">R ${order.total_amount?.toFixed(2) || '0.00'}</h5>
                                <button class="btn btn-sm btn-primary mb-2 w-100" onclick="trackOrder('${order.id}')">
                                    <i class="fas fa-route me-1"></i>Track Order
                                </button>
                                ${order.status === 'delivered' ? `
                                    <button class="btn btn-sm btn-outline-success w-100" onclick="rateOrder('${order.id}')">
                                        <i class="fas fa-star me-1"></i>Rate Order
                                    </button>
                                ` : !order.payment_reference ? `
                                    <button class="btn btn-sm btn-warning w-100" onclick="completePayment('${order.order_number}', ${order.total_amount})">
                                        <i class="fas fa-credit-card me-1"></i>Complete Payment
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function getOrderStatusInfo(status) {
            const statusMap = {
                'created': { text: 'Order Placed', icon: '📝', color: 'secondary', progress: 10 },
                'pending_confirmation': { text: 'Awaiting Pharmacy Confirmation', icon: '⏳', color: 'warning', progress: 20 },
                'confirmed': { text: 'Confirmed by Pharmacy', icon: '✅', color: 'success', progress: 40 },
                'processing': { text: 'Preparing Your Medication', icon: '⚙️', color: 'primary', progress: 60 },
                'ready_for_delivery': { text: 'Ready for Pickup', icon: '📦', color: 'info', progress: 75 },
                'out_for_delivery': { text: 'Out for Delivery', icon: '🚚', color: 'primary', progress: 90 },
                'delivered': { text: 'Delivered', icon: '✅', color: 'success', progress: 100 },
                'cancelled': { text: 'Cancelled', icon: '❌', color: 'danger', progress: 0 },
                'rx_uploaded': { text: 'Prescription Under Review', icon: '📋', color: 'info', progress: 30 }
            };
            return statusMap[status] || { text: status, icon: 'ℹ️', color: 'secondary', progress: 0 };
        }
        
        async function trackOrder(orderId) {
            const { data: order, error } = await supabaseClient
                .from('orders')
                .select(`
                    *,
                    pharmacies(name, phone, address),
                    order_items(*)
                `)
                .eq('id', orderId)
                .single();
            
            if (error || !order) {
                alert('Error loading order details');
                return;
            }
            
            const statusInfo = getOrderStatusInfo(order.status);
            const itemsHtml = order.order_items.map(item => `
                <tr>
                    <td>${item.medication_name}</td>
                    <td>${item.quantity}</td>
                    <td>R${item.unit_price?.toFixed(2)}</td>
                    <td>R${item.total_price?.toFixed(2)}</td>
                </tr>
            `).join('');
            
            const modalHtml = `
                <div class="modal fade" id="trackOrderModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-${statusInfo.color} text-white">
                                <h5 class="modal-title">Track Order: ${order.order_number}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Order Timeline -->
                                <h6 class="mb-3">Order Status</h6>
                                <div class="mb-4">
                                    ${generateTimeline(order.status)}
                                </div>
                                
                                <!-- Current Status -->
                                <div class="alert alert-${statusInfo.color} mb-3">
                                    <h5>${statusInfo.icon} ${statusInfo.text}</h5>
                                    ${order.status === 'out_for_delivery' && order.driver_contact ? `
                                        <p class="mb-0"><small>Driver Contact: ${order.driver_contact}</small></p>
                                    ` : ''}
                                </div>
                                
                                <!-- Pharmacy Info -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6>Pharmacy Details</h6>
                                        <p class="mb-1"><strong>${order.pharmacies?.name || 'N/A'}</strong></p>
                                        <p class="mb-1"><small>${order.pharmacies?.phone || ''}</small></p>
                                        <p class="mb-0"><small>${order.pharmacies?.address || ''}</small></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Delivery Address</h6>
                                        <p class="mb-1">${order.delivery_contact_name || ''}</p>
                                        <p class="mb-1"><small>${order.delivery_contact_phone || ''}</small></p>
                                        <p class="mb-0"><small>${order.delivery_address || ''}</small></p>
                                    </div>
                                </div>
                                
                                <!-- Order Items -->
                                <h6 class="mb-2">Order Items</h6>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Medication</th>
                                            <th>Qty</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsHtml}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="3">Subtotal</th>
                                            <td>R${order.subtotal?.toFixed(2) || '0.00'}</td>
                                        </tr>
                                        <tr>
                                            <th colspan="3">Delivery Fee</th>
                                            <td>R${order.delivery_fee?.toFixed(2) || '0.00'}</td>
                                        </tr>
                                        <tr>
                                            <th colspan="3">Processing Fee</th>
                                            <td>R${order.paystack_fee?.toFixed(2) || '0.00'}</td>
                                        </tr>
                                        <tr class="table-success">
                                            <th colspan="3">Total Paid</th>
                                            <th>R${order.total_amount?.toFixed(2) || '0.00'}</th>
                                        </tr>
                                    </tfoot>
                                </table>
                                
                                ${order.payment_reference ? `
                                    <p class="text-muted small">Payment Reference: ${order.payment_reference}</p>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
                                    <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">
                                        <i class="fas fa-times me-1"></i>Cancel Order
                                    </button>
                                ` : ''}
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('trackOrderModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('trackOrderModal'));
            modal.show();
        }
        
        function generateTimeline(currentStatus) {
            const steps = [
                { status: 'created', label: 'Order Placed', icon: '📝' },
                { status: 'pending_confirmation', label: 'Awaiting Confirmation', icon: '⏳' },
                { status: 'confirmed', label: 'Confirmed', icon: '✅' },
                { status: 'processing', label: 'Processing', icon: '⚙️' },
                { status: 'ready_for_delivery', label: 'Ready', icon: '📦' },
                { status: 'out_for_delivery', label: 'Out for Delivery', icon: '🚚' },
                { status: 'delivered', label: 'Delivered', icon: '✅' }
            ];
            
            const currentIndex = steps.findIndex(s => s.status === currentStatus);
            
            return `
                <div class="d-flex justify-content-between align-items-center position-relative">
                    <div class="position-absolute w-100" style="height: 4px; background: #e0e0e0; top: 20px; z-index: 0;"></div>
                    ${steps.map((step, index) => `
                        <div class="text-center position-relative" style="z-index: 1;">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                 style="width: 40px; height: 40px; background: ${index <= currentIndex ? '#28a745' : '#e0e0e0'}; color: white;">
                                ${step.icon}
                            </div>
                            <p class="small mb-0" style="max-width: 80px;">${step.label}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order? This action cannot be undone.')) return;
            
            const { error } = await supabaseClient
                .from('orders')
                .update({ status: 'cancelled' })
                .eq('id', orderId);
            
            if (error) {
                alert('Error cancelling order: ' + error.message);
                return;
            }
            
            alert('Order cancelled successfully');
            bootstrap.Modal.getInstance(document.getElementById('trackOrderModal')).hide();
            await loadOrders();
        }
        
        function rateOrder(orderId) {
            alert('Rating feature coming soon! Order ID: ' + orderId);
        }
        
        function completePayment(orderNumber, amount) {
            alert(`Payment for order ${orderNumber} (R${amount.toFixed(2)}) - Paystack integration here`);
        }
        
        async function trackOrder(orderId) {
            const { data: order } = await supabaseClient
                .from('orders')
                .select('*, order_status_history(*)')
                .eq('id', orderId)
                .single();
            
            const timeline = `
                <div class="order-timeline">
                    ${order.order_status_history?.map(h => `
                        <div class="timeline-item ${h.to_status === order.status ? 'completed' : ''}">
                            <strong>${h.to_status.replace(/_/g, ' ').toUpperCase()}</strong><br>
                            <small class="text-muted">${new Date(h.created_at).toLocaleString()}</small>
                        </div>
                    `).join('') || '<p>No tracking history</p>'}
                </div>
            `;
            
            document.getElementById('trackingContent').innerHTML = timeline;
            new bootstrap.Modal(document.getElementById('orderTrackingModal')).show();
        }
        
        async function loadChronicMedications() {
            const user = await getCurrentUser();
            if (!user) return;
            
            const { data: enrollments } = await supabaseClient
                .from('chronic_enrollments')
                .select('*')
                .eq('patient_id', user.id)
                .eq('status', 'active');
            
            const container = document.getElementById('chronicMedications');
            
            if (!enrollments || enrollments.length === 0) {
                container.innerHTML = '<p class="text-muted">No active chronic medication enrollments</p>';
                return;
            }
            
            container.innerHTML = enrollments.map(enrollment => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>${enrollment.medication_name}</h6>
                        <p class="mb-1"><small>Dosage: ${enrollment.dosage}</small></p>
                        <p class="mb-1"><small>Frequency: ${enrollment.frequency}</small></p>
                        <p class="mb-1"><small>Next Delivery: ${enrollment.next_delivery_date}</small></p>
                        <button class="btn btn-sm btn-warning" onclick="pauseChronicMed('${enrollment.id}')">
                            <i class="fas fa-pause me-1"></i>Pause
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function pauseChronicMed(enrollmentId) {
            if (!confirm('Are you sure you want to pause this chronic medication delivery?')) return;
            
            const pauseUntil = prompt('Pause until date (YYYY-MM-DD):');
            if (!pauseUntil) return;
            
            await supabaseClient
                .from('chronic_enrollments')
                .update({
                    status: 'paused',
                    paused_until: pauseUntil,
                    pause_reason: 'Patient request'
                })
                .eq('id', enrollmentId);
            
            alert('Chronic medication paused successfully');
            loadChronicMedications();
        }
        
        async function updateProfile() {
            const user = await getCurrentUser();
            if (!user) return;
            
            const { error } = await supabaseClient
                .from('user_profiles')
                .update({
                    full_name: document.getElementById('profileFullName').value,
                    phone_number: document.getElementById('profilePhone').value,
                    id_number: document.getElementById('profileIdNumber').value,
                    date_of_birth: document.getElementById('profileDOB').value,
                    street_address: document.getElementById('profileAddress').value,
                    city: document.getElementById('profileCity').value,
                    province: document.getElementById('profileProvince').value,
                    postal_code: document.getElementById('profilePostalCode').value,
                    marketing_consent: document.getElementById('consentMarketing').checked
                })
                .eq('id', user.id);
            
            if (error) {
                alert('Error updating profile: ' + error.message);
            } else {
                alert('Profile updated successfully!');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
