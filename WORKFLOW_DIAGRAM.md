# ğŸ“Š PAYMENT BOOKING WORKFLOW - VISUAL GUIDE

## Complete Appointment Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PATIENT BOOKING JOURNEY                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START: Patient visits nurse.html
   â”‚
   â”œâ”€â”€> Clicks "Book with Payment" button
   â”‚
   â”œâ”€â”€> Redirected to appointment-booking.html
   â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  STEP 1: SELECT PRACTITIONER & TIME       â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  â€¢ Choose practitioner from dropdown      â”‚
   â”‚    â”‚  â€¢ Select date (calendar)                 â”‚
   â”‚    â”‚  â€¢ Select time slot                       â”‚
   â”‚    â”‚  â€¢ Enter reason for visit                 â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> Next: Patient Details
   â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  STEP 2: PATIENT DETAILS                  â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  â€¢ Full name                              â”‚
   â”‚    â”‚  â€¢ Phone number                           â”‚
   â”‚    â”‚  â€¢ Email address                          â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> Next: Payment
   â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  STEP 3: PAYMENT SUMMARY                  â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  Consultation Fee:          R 500.00      â”‚
   â”‚    â”‚  - Practitioner gets:       R 400 (80%)   â”‚
   â”‚    â”‚  - Platform fee:            R 100 (20%)   â”‚
   â”‚    â”‚                                            â”‚
   â”‚    â”‚  Cancellation Policy:                     â”‚
   â”‚    â”‚  â€¢ â‰¥24h before: Full refund               â”‚
   â”‚    â”‚  â€¢ <24h before: No refund                 â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> Clicks "Pay R500" button
   â”‚
   â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND PROCESSING STARTS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”‚
   â”œâ”€â”€> appointment-booking.js â†’ createPendingAppointment()
   â”‚
   â”‚    â€¢ Generate unique booking_id (BK1738123456789)
   â”‚    â€¢ Generate payment_reference (APT_1738123456_7890)
   â”‚    â€¢ Calculate confirmation_deadline (NOW + 24 hours)
   â”‚    â€¢ Calculate payment split (R400 + R100)
   â”‚
   â”œâ”€â”€> INSERT INTO appointments
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  Database Record Created:                 â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  status: PENDING_PAYMENT                  â”‚
   â”‚    â”‚  payment_status: pending                  â”‚
   â”‚    â”‚  amount_paid: 500                         â”‚
   â”‚    â”‚  platform_fee: 100                        â”‚
   â”‚    â”‚  practitioner_amount: 400                 â”‚
   â”‚    â”‚  confirmation_deadline: 2026-01-29 12:00  â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> appointment_logs â†’ INSERT
   â”‚    â€¢ action: 'appointment_created'
   â”‚    â€¢ actor: 'patient'
   â”‚
   â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PAYSTACK PAYMENT FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”‚
   â”œâ”€â”€> paystack-integration.js â†’ initiatePayment()
   â”‚
   â”œâ”€â”€> PaystackPop.setup() called
   â”‚
   â”œâ”€â”€> Paystack Inline Modal Opens
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  PAYSTACK PAYMENT MODAL                   â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  Amount: R 500.00                         â”‚
   â”‚    â”‚  Reference: APT_1738123456_7890           â”‚
   â”‚    â”‚                                            â”‚
   â”‚    â”‚  [Card Number]                            â”‚
   â”‚    â”‚  [Expiry] [CVV]                           â”‚
   â”‚    â”‚  [PIN]                                     â”‚
   â”‚    â”‚                                            â”‚
   â”‚    â”‚  [Pay Now] [Cancel]                       â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> Patient enters card details
   â”‚
   â”œâ”€â”€> Paystack processes payment
   â”‚
   â”œâ”€â”€> PAYMENT SUCCESSFUL
   â”‚
   â”œâ”€â”€> Callback: onSuccess(response)
   â”‚
   â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAYMENT SUCCESS HANDLING                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”‚
   â”œâ”€â”€> appointment-booking.js â†’ updateAppointmentAfterPayment()
   â”‚
   â”œâ”€â”€> paystack-integration.js â†’ verifyPayment(reference)
   â”‚    â€¢ Call Paystack API: /transaction/verify/:reference
   â”‚    â€¢ Confirm payment status = success
   â”‚
   â”œâ”€â”€> UPDATE appointments
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  Database Updated:                        â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  status: PENDING_CONFIRMATION âœ…          â”‚
   â”‚    â”‚  payment_status: success âœ…               â”‚
   â”‚    â”‚  payment_metadata: {Paystack data}        â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€> INSERT INTO payment_transactions
   â”‚    â€¢ reference: APT_1738123456_7890
   â”‚    â€¢ transaction_type: 'payment'
   â”‚    â€¢ amount: 500
   â”‚    â€¢ status: 'success'
   â”‚
   â”œâ”€â”€> INSERT INTO appointment_logs
   â”‚    â€¢ action: 'payment_successful'
   â”‚    â€¢ actor: 'system'
   â”‚
   â”œâ”€â”€> INSERT INTO practitioner_notifications
   â”‚    â€¢ notification_type: 'new_appointment'
   â”‚    â€¢ message: "New appointment - Please confirm within 24h"
   â”‚
   â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK CONFIRMATION (Async)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”‚ (Happens in parallel)
   â”‚
   â”œâ”€â”€> Paystack sends webhook to /api/webhooks/paystack
   â”‚
   â”œâ”€â”€> Event: charge.success
   â”‚
   â”œâ”€â”€> Verify signature (HMAC SHA512)
   â”‚
   â”œâ”€â”€> Find appointment by payment_reference
   â”‚
   â”œâ”€â”€> UPDATE appointments (confirm payment status)
   â”‚
   â”œâ”€â”€> Record webhook in payment_transactions
   â”‚
   â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUCCESS SCREEN SHOWN                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”‚
   â”œâ”€â”€> Show Step 4: Confirmation
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  âœ“ Payment Successful!                    â”‚
   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚    â”‚  Booking Reference: BK1738123456789       â”‚
   â”‚    â”‚  Practitioner: Dr. Test                   â”‚
   â”‚    â”‚  Date: 2026-01-29 @ 10:00 AM              â”‚
   â”‚    â”‚  Amount Paid: R 500.00                    â”‚
   â”‚    â”‚  Status: PENDING_CONFIRMATION             â”‚
   â”‚    â”‚                                            â”‚
   â”‚    â”‚  Next Steps:                              â”‚
   â”‚    â”‚  1. Practitioner will confirm in 24h      â”‚
   â”‚    â”‚  2. You'll receive notification           â”‚
   â”‚    â”‚  3. Auto-refund if not confirmed          â”‚
   â”‚    â”‚                                            â”‚
   â”‚    â”‚  [View My Appointments] [Book Another]    â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    AUTOMATED WORKFLOWS (Background)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW A: PRACTITIONER CONFIRMATION (Happy Path)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Within 24 hours:
   â”‚
   â”œâ”€â”€> Practitioner logs into dashboard
   â”‚
   â”œâ”€â”€> Sees notification: "New appointment from Patient X"
   â”‚
   â”œâ”€â”€> Clicks "Confirm Appointment"
   â”‚
   â”œâ”€â”€> appointment-booking.js â†’ confirmAppointment()
   â”‚
   â”œâ”€â”€> UPDATE appointments
   â”‚    â€¢ status: CONFIRMED âœ…
   â”‚    â€¢ confirmed_at: NOW
   â”‚
   â”œâ”€â”€> INSERT INTO appointment_logs
   â”‚    â€¢ action: 'practitioner_confirmed'
   â”‚
   â”œâ”€â”€> Notify patient via email/SMS
   â”‚    "Your appointment is confirmed!"
   â”‚
   â”œâ”€â”€> Appointment occurs on scheduled date
   â”‚
   â”œâ”€â”€> Mark as COMPLETED
   â”‚
   â”œâ”€â”€> Practitioner receives payout (R400) via Paystack split
   â”‚
   END: SUCCESS âœ…


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW B: UNCONFIRMED TIMEOUT (Auto-Refund)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   After 24 hours (no practitioner response):
   â”‚
   â”œâ”€â”€> CRON JOB runs: /api/cron/check-confirmations (hourly)
   â”‚
   â”œâ”€â”€> Query: SELECT * FROM appointments 
   â”‚           WHERE status = 'PENDING_CONFIRMATION'
   â”‚           AND confirmation_deadline < NOW()
   â”‚
   â”œâ”€â”€> Found 1 overdue appointment
   â”‚
   â”œâ”€â”€> FOR EACH overdue:
   â”‚
   â”œâ”€â”€â”€â”€> Call Paystack Refund API
   â”‚      â€¢ POST /refund
   â”‚      â€¢ transaction: APT_1738123456_7890
   â”‚      â€¢ amount: 50000 (kobo = R500)
   â”‚      â€¢ reason: "Practitioner did not confirm within 24h"
   â”‚
   â”œâ”€â”€â”€â”€> Paystack processes refund
   â”‚
   â”œâ”€â”€â”€â”€> UPDATE appointments
   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      â”‚  status: REFUNDED âœ…                  â”‚
   â”‚      â”‚  payment_status: refunded             â”‚
   â”‚      â”‚  refund_reference: RF123456           â”‚
   â”‚      â”‚  refunded_at: NOW                     â”‚
   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â”€â”€â”€> INSERT INTO payment_transactions
   â”‚      â€¢ transaction_type: 'refund'
   â”‚      â€¢ amount: 500
   â”‚      â€¢ status: 'success'
   â”‚
   â”œâ”€â”€â”€â”€> INSERT INTO appointment_logs
   â”‚      â€¢ action: 'auto_refund_unconfirmed'
   â”‚      â€¢ actor: 'system'
   â”‚
   â”œâ”€â”€â”€â”€> Notify patient
   â”‚      "Your R500 has been refunded - practitioner did not confirm"
   â”‚
   END: REFUNDED âœ…


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW C: PATIENT CANCELLATION (â‰¥24h before)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Patient clicks "Cancel Appointment" in UI:
   â”‚
   â”œâ”€â”€> Check: appointment_date - NOW >= 24 hours?
   â”‚
   â”œâ”€â”€> YES â†’ Full refund eligible
   â”‚
   â”œâ”€â”€> appointment-booking.js â†’ handlePatientCancellation()
   â”‚
   â”œâ”€â”€> Call Paystack Refund API (R500)
   â”‚
   â”œâ”€â”€> UPDATE appointments
   â”‚    â€¢ status: REFUNDED
   â”‚    â€¢ cancelled_by: 'patient'
   â”‚    â€¢ cancellation_reason: "Patient cancelled 48h before"
   â”‚
   â”œâ”€â”€> Notify practitioner
   â”‚    "Appointment cancelled by patient - refund issued"
   â”‚
   END: FULL REFUND âœ…


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW D: PATIENT CANCELLATION (<24h before)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Patient tries to cancel 12 hours before:
   â”‚
   â”œâ”€â”€> Check: appointment_date - NOW < 24 hours?
   â”‚
   â”œâ”€â”€> YES â†’ No refund (no-show policy)
   â”‚
   â”œâ”€â”€> UPDATE appointments
   â”‚    â€¢ status: CANCELLED
   â”‚    â€¢ cancelled_by: 'patient'
   â”‚    â€¢ no_show_fee: 500 (full amount retained)
   â”‚
   â”œâ”€â”€> Show message to patient
   â”‚    "Cancellation within 24h - no refund per policy"
   â”‚
   â”œâ”€â”€> Practitioner still receives payout (R400)
   â”‚
   END: NO REFUND (Policy enforced) âš ï¸


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW E: PRACTITIONER CANCELLATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Practitioner cancels after confirming:
   â”‚
   â”œâ”€â”€> Practitioner clicks "Cancel Appointment"
   â”‚
   â”œâ”€â”€> appointment-booking.js â†’ handlePractitionerCancellation()
   â”‚
   â”œâ”€â”€> Call Paystack Refund API (R500) - FULL REFUND regardless of timing
   â”‚
   â”œâ”€â”€> UPDATE appointments
   â”‚    â€¢ status: REFUNDED
   â”‚    â€¢ cancelled_by: 'practitioner'
   â”‚
   â”œâ”€â”€> Notify patient
   â”‚    "Practitioner cancelled - full refund issued"
   â”‚
   â”œâ”€â”€> Optional: Issue goodwill credit
   â”‚
   END: FULL REFUND + GOODWILL âœ…


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WORKFLOW F: NO-SHOW DETECTION                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   After appointment time passes:
   â”‚
   â”œâ”€â”€> CRON JOB runs: /api/cron/check-no-shows (hourly)
   â”‚
   â”œâ”€â”€> Query: SELECT * FROM appointments
   â”‚           WHERE status = 'CONFIRMED'
   â”‚           AND appointment_date + appointment_time < NOW()
   â”‚           AND no_show_checked = false
   â”‚
   â”œâ”€â”€> Found appointments past their time
   â”‚
   â”œâ”€â”€> FOR EACH past appointment:
   â”‚
   â”œâ”€â”€â”€â”€> UPDATE appointments
   â”‚      â€¢ status: NO_SHOW âš ï¸
   â”‚      â€¢ no_show_checked: true
   â”‚      â€¢ no_show_fee: 500
   â”‚
   â”œâ”€â”€â”€â”€> Notify practitioner
   â”‚      "Appointment marked NO_SHOW - update if patient attended"
   â”‚
   â”œâ”€â”€â”€â”€> Practitioner can override if patient actually attended
   â”‚
   END: NO_SHOW MARKED âš ï¸


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         DATABASE STATE DIAGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

appointments.status transitions:

    PENDING_PAYMENT
         â”‚
         â”‚ (Payment succeeds)
         â–¼
    PENDING_CONFIRMATION
         â”‚
         â”œâ”€â”€> (24h timeout) â”€â”€â”€â”€â”€â”€> REFUNDED
         â”‚
         â”œâ”€â”€> (Practitioner confirms)
         â”‚         â”‚
         â”‚         â–¼
         â”‚    CONFIRMED
         â”‚         â”‚
         â”‚         â”œâ”€â”€> (Appointment occurs) â”€â”€> COMPLETED
         â”‚         â”‚
         â”‚         â”œâ”€â”€> (No-show) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> NO_SHOW
         â”‚         â”‚
         â”‚         â”œâ”€â”€> (Practitioner cancels) â”€â”€> REFUNDED
         â”‚         â”‚
         â”‚         â””â”€â”€> (Patient cancels â‰¥24h) â”€â”€> REFUNDED
         â”‚                   â”‚
         â”‚                   â””â”€â”€> (Patient cancels <24h) â”€â”€> CANCELLED
         â”‚
         â””â”€â”€> (Practitioner declines) â”€â”€> REFUNDED


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         MONEY FLOW DIAGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient pays R500 via Paystack:
    â”‚
    â”œâ”€â”€> Paystack receives R500
    â”‚
    â”œâ”€â”€> Paystack fee deducted (~R15)
    â”‚
    â”œâ”€â”€> Remaining R485 split:
    â”‚    
    â”œâ”€â”€â”€> 80% to Practitioner Subaccount = R400 (goes to their bank)
    â”‚     (Paystack automatically transfers to practitioner's bank)
    â”‚
    â””â”€â”€â”€> 20% to Platform Account = R100 (your revenue)
          (Paystack automatically transfers to your bank)


Refund scenario:
    â”‚
    â”œâ”€â”€> Refund initiated (R500)
    â”‚
    â”œâ”€â”€> Paystack reverses the split:
    â”‚    
    â”œâ”€â”€â”€> R400 taken back from practitioner settlement
    â”‚
    â””â”€â”€â”€> R100 taken back from platform settlement
    â”‚
    â””â”€â”€> Full R500 returned to patient's original payment method


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              THE END
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Every scenario is covered:
âœ… Happy path (booking â†’ payment â†’ confirm â†’ attend)
âœ… Timeout refund (no confirmation)
âœ… Patient cancels (early vs late)
âœ… Practitioner cancels
âœ… Practitioner declines
âœ… No-show handling
âœ… All logged in appointment_logs
âœ… All financial transactions in payment_transactions
âœ… Full audit trail for disputes
